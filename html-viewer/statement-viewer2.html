<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>SEC Statement Viewer</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://jeffreymaniac.github.io/OpenDyslexic-font-for-css/opendyslexic.css" />

  <style>
    body {
        font-family: 'OpenDyslexic', sans-serif; /* Example using OpenDyslexic */
        font-size:0.9rem;
    }
    .table-responsive-sm th, .table-responsive-sm td {
        white-space: normal; /* Allow wrapping in cells */
        word-break: break-word;
    }
    .table-responsive-sm th:first-child, .table-responsive-sm td:first-child {
        min-width: 250px; /* Ensure first column has enough space */
        white-space: normal;
        position: sticky; /* Make first column sticky */
        left: 0;
        background-color: #f8f9fa; /* Match table background or choose a contrast */
        z-index: 1; /* Ensure it's above other cells but below sticky header */
    }
    .table-responsive-sm td:not(:first-child) {
        text-align: right;
        white-space: nowrap;
    }
    .table-responsive-sm thead th {
        position: sticky;
        top: 0;
        background-color: #e9ecef; /* Bootstrap default thead a bit darker */
        z-index: 2; /* Higher z-index for the header */
    }
    /* Ensure the top-left corner cell (sticky header + sticky column) is styled correctly */
    .table-responsive-sm thead th:first-child {
        z-index: 3; /* Highest z-index */
    }
    th a { /* For links in headers */
        color: #007bff;
    }
    th a:hover {
        text-decoration: underline;
    }
    /* Equity table specific styling for values */
    .equity-table td:not(:first-child) {
        text-align: right;
    }
    .equity-table .equity-header-row th { /* For column headers in equity table */
        font-size: 0.8em;
        white-space: normal;
        text-align: center;
    }
    .statement-container { /* Container for each individual table */
        margin-bottom: 2rem;
        border: 1px solid #dee2e6;
        border-radius: .25rem;
        padding: 1rem;
        background-color: #fff;
    }
    .statement-header {
        margin-bottom: 0.75rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #dee2e6;
    }
    .statement-header h3 { margin: 0; font-size: 1.1rem; }
    .statement-header p { margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #6c757d; }
  </style>
</head>

<body class="container-fluid fs-6">

  <div>
    <h1>SEC Statement Viewer</h1>

    <div id="formContainer" class="container py-5">
      <form id="stmtForm">
        <div class="row justify-content-top p-2">
          <div class="col input-group">
              <div class="input-group-prepend">
                <span class="input-group-text">Ticker:</span>
              </div>
              <input type="text" id="tickerInput" name="ticker" class="form-control" required="true" placeholder="e.g., NVDA, AAPL" value="NVDA" />
          </div>
        </div>

        <div class="row justify-content-top px-2">
          <div class="col-3 input-group">
            <div class="input-group-prepend">
              <span class="input-group-text">Statement:</span>
            </div>
            <select id="statementTypeInput" name="type" class="form-control">
              <option value="">All Types</option>
              <option value="INCOME">Income</option>
              <option value="BALANCE">Balance Sheet</option>
              <option value="CASHFLOW">Cash Flow</option>
              <option value="EQUITY" selected>Equity</option>
            </select>
          </div>

          <div class="col-3 input-group">
            <div class="input-group-prepend">
              <span class="input-group-text">Form Type:</span>
            </div>
            <select id="formTypeInput" name="formType" class="form-control">
              <option value="">Both</option>
              <option value="10-K" selected>10-K</option>
              <option value="10-Q">10-Q</option>
            </select>
          </div>
        
          <div class="col-3 input-group">
            <div class="input-group-prepend">
              <span class="input-group-text">Periods (Limit):</span>
            </div>
            <input type="number" id="limitInput" name="limit" value="10" min="1" max="50" class="form-control">
          </div>

          <div class="col-3 input-group">
            <div class="input-group-prepend">
              <span class="input-group-text">Order:</span>
            </div>
            <select id="sortInput" name="sort" class="form-control"> <option value="desc" selected>Newest First</option>
              <option value="asc">Oldest First</option>
            </select>
          </div>
        </div>
        
        <div class="row justify-content-center p-2">
          <button type="submit" class="btn btn-primary col justify-content-center ml-2 mr-2">Fetch Statements</button>
        </div>
      </form>
    </div>
    <div id="stmtContainer" class="table-responsive-sm">
        </div>
  </div>
    <script>
    // Helper function to format date as YYYY-MM-DD
    function getISODate(dateString) {
        if (!dateString) return 'N/A_Date';
        try { return new Date(dateString).toISOString().split('T')[0]; }
        catch (e) { return dateString; }
    }
    // Helper function to format date for display
    function formatDateForDisplay(dateString) {
        if (!dateString) return 'N/A';
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', timeZone: 'UTC' });
        } catch (e) { return dateString; }
    }
    // Helper function to format numbers
    function formatNumber(value) {
        if (typeof value === 'number') { return value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); }
        if (value === null || value === undefined) return '-';
        const num = parseFloat(String(value).replace(/,/g, ''));
        if (!isNaN(num)) { return num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); }
        return String(value);
    }
    function logMessage(message, data = null) { console.log(message, data !== null ? JSON.stringify(data, null, 2) : ''); }


    /**
     * Main display router. Decides which rendering function to call.
     */
    function displayStatements(statements) {
        const container = document.getElementById('stmtContainer');
        container.innerHTML = ''; // Clear previous content

        if (!statements || statements.length === 0) {
            container.innerHTML = '<p class="text-muted">No statements to display.</p>';
            return;
        }

        // Group by statement type (if API doesn't pre-filter)
        const selectedType = document.getElementById('statementTypeInput').value.toUpperCase();
        let statementsToDisplay = statements;
        if (selectedType) {
            statementsToDisplay = statements.filter(stmt => stmt.statementType?.toUpperCase() === selectedType);
        }

        if (statementsToDisplay.length === 0) {
             container.innerHTML = `<p class="text-muted">No statements found for type: ${selectedType}.</p>`;
             return;
        }

        const firstType = statementsToDisplay[0].statementType?.toUpperCase();

        if (firstType === 'EQUITY') {
            // Sort equity statements by date individually before rendering
            statementsToDisplay.sort((a, b) => new Date(b.filingDate).getTime() - new Date(a.filingDate).getTime());
            statementsToDisplay.forEach(stmt => {
                container.appendChild(renderSingleEquityTable(stmt));
            });
        } else {
            // For other types, use the comparative table
            container.appendChild(transformJSON(statementsToDisplay));
        }
    }


    /**
     * Renders a SINGLE Equity statement table.
     * @param {object} stmt - A StatementDocument object for an Equity statement.
     * @returns {HTMLElement} - The generated table container element.
     */
    function renderSingleEquityTable(stmt) {
        logMessage(`renderSingleEquityTable for: ${stmt._id}`);
        const tableContainer = document.createElement('div');
        tableContainer.className = 'statement-container table-scroll-container';

        const headerDiv = document.createElement('div');
        headerDiv.className = 'statement-header';
        const accessionSimple = stmt.accessionNumber.replace(/-/g, '');
        const secLink = `https://www.sec.gov/Archives/edgar/data/${stmt.cik}/${accessionSimple}/${stmt.sourceFile}`;
        headerDiv.innerHTML = `
            <h3>${stmt.statementType?.toUpperCase()} (${stmt.formType})</h3>
            <p>
                Filing Date: ${formatDateForDisplay(stmt.filingDate)} |
                Source: <a href="${secLink}" target="_blank" rel="noopener noreferrer">${stmt.sourceFile}</a> |
                Accession: ${stmt.accessionNumber}
            </p>`;
        tableContainer.appendChild(headerDiv);

        const table = document.createElement('table');
        table.className = 'table table-sm table-bordered equity-table'; // Bootstrap classes
        const thead = table.createTHead();
        const tbody = table.createTBody();

        const equityData = stmt.parsedData?.equityData || stmt.parsedData; // Adapt to structure
        if (!Array.isArray(equityData) || equityData.length === 0) {
            tbody.innerHTML = '<tr><td>No equity data found.</td></tr>';
            tableContainer.appendChild(table);
            return tableContainer;
        }

        let headers = ["Item"];
        let dataRows = equityData;

        // Check for a 'headers' row in the parsed data
        if (equityData[0] && typeof equityData[0] === 'object' && equityData[0].headers && Array.isArray(equityData[0].headers)) {
            headers = headers.concat(equityData[0].headers);
            dataRows = equityData.slice(1); // Data rows start after the header row
            logMessage("Using explicit headers for equity table:", headers);
        } else {
            // Infer number of columns from the first data row's array length
            const firstDataRowKey = Object.keys(dataRows[0])[0];
            const firstDataRowValues = dataRows[0][firstDataRowKey];
            if (Array.isArray(firstDataRowValues)) {
                for (let i = 0; i < firstDataRowValues.length; i++) {
                    headers.push(`Column ${i + 1}`);
                }
            } else { // Fallback if not an array (should not happen for equity)
                headers.push("Value");
            }
            logMessage("Inferred headers for equity table:", headers);
        }

        const headerRow = thead.insertRow();
        headerRow.classList.add("equity-header-row");
        headers.forEach(headerText => {
            const th = document.createElement('th');
            th.textContent = headerText;
            headerRow.appendChild(th);
        });

        dataRows.forEach(item => {
            if (typeof item !== 'object' || item === null) return;
            const row = tbody.insertRow();
            const itemKey = Object.keys(item)[0];
            const itemValues = item[itemKey];

            row.insertCell().textContent = itemKey; // Line item description

            if (Array.isArray(itemValues)) {
                itemValues.forEach(val => {
                    row.insertCell().textContent = formatNumber(val);
                });
                // Pad with empty cells if necessary
                for (let i = itemValues.length; i < headers.length - 1; i++) {
                    row.insertCell().textContent = '-';
                }
            } else { // Should not happen for equity data format
                const cell = row.insertCell();
                cell.textContent = formatNumber(itemValues);
                cell.colSpan = headers.length > 1 ? headers.length -1 : 1;
            }
        });

        tableContainer.appendChild(table);
        return tableContainer;
    }


    const transformJSON = (data) => {
        // This function is now for comparative tables (Income, Balance, Cashflow)
        // It uses the "Union of Keys" approach and includes SEC links in headers
        logMessage("transformJSON (Comparative): Starting with data:", data);
        if (!data || !Array.isArray(data) || data.length === 0) { /* ... error handling ... */ }

        const mapOfMasterKeys = new Map();
        const columnValueMaps = new Map();
        const columnHeaderData = []; // Stores objects for header construction and sorting

        const tbl = document.createElement("table");
        tbl.setAttribute('id', `${data[0].statementType?.toLowerCase() || 'statement'}`);
        tbl.setAttribute('class', 'table table-striped table-bordered');

        const tHead = document.createElement("thead"); tHead.setAttribute('class', 'thead-light');
        const tBody = document.createElement("tbody");
        tbl.appendChild(tHead);
        tbl.appendChild(tBody);

        const headerRow = tHead.insertRow();
        const headerTitleCell = document.createElement('th');
        const firstStmtMetadata = data[0]?.parsedData?.metadata;
        headerTitleCell.innerHTML = `${data[0].statementType?.toUpperCase() || 'STATEMENT'} <br><small>${firstStmtMetadata?.currency || ''} ${firstStmtMetadata?.units || ''}</small>`;
        headerRow.appendChild(headerTitleCell);

        // --- PASS 1: Identify unique columns and collect all master line item keys ---
        data.forEach((stmt) => {
            if (!stmt || !stmt.filingDate || !stmt.sourceFile || !stmt.formType || !stmt.cik || !stmt.accessionNumber) {return;}
            const uniqueColumnKey = `${getISODate(stmt.filingDate)}_${stmt.formType}_${stmt.sourceFile}`;

            if (!columnValueMaps.has(uniqueColumnKey)) {
                columnHeaderData.push({
                    uniqueKey: uniqueColumnKey,
                    display: `${formatDateForDisplay(stmt.filingDate)} (${stmt.formType} ${stmt.sourceFile})`,
                    dateForSort: new Date(stmt.filingDate),
                    sourceFileForSort: stmt.sourceFile,
                    cik: stmt.cik,
                    accessionNumber: stmt.accessionNumber.replace(/-/g, ''),
                    originalSourceFile: stmt.sourceFile
                });
                columnValueMaps.set(uniqueColumnKey, new Map());
            }
            const currentParsedData = stmt.parsedData?.stmtData || stmt.parsedData;
            if (Array.isArray(currentParsedData)) {
                currentParsedData.forEach((entry) => {
                    if (typeof entry === 'object' && entry !== null && Object.keys(entry).length > 0) {
                        const itemKey = Object.keys(entry)[0];
                        const itemValue = entry[itemKey];
                        if (itemKey && !mapOfMasterKeys.has(itemKey)) {
                            mapOfMasterKeys.set(itemKey, true);
                        }
                        columnValueMaps.get(uniqueColumnKey).set(itemKey, itemValue);
                    }
                });
            }
        });

        columnHeaderData.sort((a, b) => { /* ... sorting logic ... */ });
        const orderedMasterKeys = Array.from(mapOfMasterKeys.keys());

        columnHeaderData.forEach(colData => {
            const headerCell = document.createElement('th');
            const stmtURI = document.createElement('a');
            stmtURI.href = `https://www.sec.gov/Archives/edgar/data/${colData.cik}/${colData.accessionNumber}/${colData.originalSourceFile}`;
            stmtURI.target = `_blank`; stmtURI.rel = 'noopener noreferrer';
            stmtURI.innerHTML = colData.display.replace(/ \(/, '<br>(');
            headerCell.appendChild(stmtURI);
            headerRow.appendChild(headerCell);
        });

        // --- PASS 2: Populate data cells ---
        orderedMasterKeys.forEach((rowLabel) => {
            if (typeof rowLabel === 'string' && rowLabel.trim().endsWith(':')) { return; }
            const tblrow = tBody.insertRow();
            tblrow.insertCell().textContent = rowLabel;
            columnHeaderData.forEach(colData => {
                const cell = tblrow.insertCell();
                const itemsForColumn = columnValueMaps.get(colData.uniqueKey);
                const value = itemsForColumn?.get(rowLabel);
                cell.innerHTML = formatNumber(value); // Simplified display for this example
            });
        });
        const container = document.createElement('div');
        container.classList.add('table-scroll-container');
        container.appendChild(tbl);
        return container;
    };

    // DOMContentLoaded and Fetch Logic (from your baseline)
    document.addEventListener('DOMContentLoaded', async (evt) => {
      const form = document.getElementById('stmtForm');
      const container = document.getElementById('stmtContainer'); // This is where tables will be appended

      form.addEventListener('submit', async (evt) => {
        evt.preventDefault();
        container.innerHTML = '<p class="text-info">Fetching data...</p>'; // Simple loading message

        const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
        const type = document.getElementById('statementTypeInput').value;
        const formType = document.getElementById('formTypeInput').value;
        const limit = document.getElementById('limitInput').value;
        const sort = document.getElementById('sortInput').value;

        const queryParams = new URLSearchParams();
        if (type) queryParams.append('type', type);
        if (formType) queryParams.append('formType', formType);
        if (limit) queryParams.append('limit', limit);
        if (sort) queryParams.append('sort', sort);

        const url = `http://localhost:3000/api/v1/statements/${ticker}?${queryParams.toString()}`;
        console.log("Fetching URL:", url);

        try {
            const response = await fetch(url);
            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`HTTP error! status: ${response.status} - ${errText.substring(0,100)}`);
            }
            const responseData = await response.json();
            console.log("API Response:", responseData);

            if (responseData.success && Array.isArray(responseData.data)) {
                container.innerHTML = ''; // Clear loading message
                if (responseData.data.length > 0) {
                    // Call the main display router function
                    displayStatements(responseData.data);
                } else {
                    container.innerHTML = '<p class="text-muted">No statements found for the given criteria.</p>';
                }
            } else {
                throw new Error(responseData.messageTxt || "Invalid data structure from API.");
            }
        } catch (error) {
            console.error("Fetch or transform error:", error);
            container.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
        }
      });
    });
    </script>


  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
    integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>
</body>
</html>
